name: Level 4 - Multi-Environment CI/CD

on:
  push:
    branches: 
      - main
      - dev
      - 'feature/**'
    paths:
      - 'development/client/**'
      - 'development/server/**'
      - 'devops/helm/**'
      - '.github/workflows/multi-env-pipeline.yml'

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_NAME }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0  # For semantic versioning

    - name: Setup Git config
      run: |
        git config user.email "github-actions@github.com"
        git config user.name "GitHub Actions"

    - name: Determine Version Tag
      id: version
      run: |
        BRANCH_NAME="${GITHUB_REF##*/}"
        
        if [ "$BRANCH_NAME" = "main" ]; then
          # Semantic versioning for main branch
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            # No tags exist, this is first release
            echo "No existing tags found, starting from v0.1.0"
            NEW_VERSION="v0.1.0"
          else
            echo "Latest tag: $LATEST_TAG"
            
            # Parse version
            VERSION=${LATEST_TAG#v}
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            PATCH=$(echo $VERSION | cut -d. -f3)
            
            # Check commit messages for version bump
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=%B)
            
            if echo "$COMMITS" | grep -qi "BREAKING CHANGE"; then
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
            elif echo "$COMMITS" | grep -qi "^feat"; then
              MINOR=$((MINOR + 1))
              PATCH=0
            else
              PATCH=$((PATCH + 1))
            fi
            
            NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          fi
          
          echo "New version: $NEW_VERSION"
          echo "tag=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "image_tag=$NEW_VERSION" >> $GITHUB_OUTPUT
          
        elif [ "$BRANCH_NAME" = "dev" ]; then
          # Dev branch uses dev-<sha>
          echo "tag=dev-${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "image_tag=dev-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          
        else
          # Feature branch uses feature-<sha>
          echo "tag=feature-${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "image_tag=feature-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
        fi

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_NAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    # Build and Push Client
    - name: Build and Push Client Image
      run: |
        docker build \
          -t $DOCKER_USERNAME/devops-client:${{ steps.version.outputs.image_tag }} \
          -t $DOCKER_USERNAME/devops-client:latest \
          -f development/client/Dockerfile \
          development/client
        docker push $DOCKER_USERNAME/devops-client:${{ steps.version.outputs.image_tag }}
        docker push $DOCKER_USERNAME/devops-client:latest

    # Build and Push Server
    - name: Build and Push Server Image
      run: |
        docker build \
          -t $DOCKER_USERNAME/devops-server:${{ steps.version.outputs.image_tag }} \
          -t $DOCKER_USERNAME/devops-server:latest \
          -f development/server/Dockerfile \
          development/server
        docker push $DOCKER_USERNAME/devops-server:${{ steps.version.outputs.image_tag }}
        docker push $DOCKER_USERNAME/devops-server:latest

    # Update Helm Chart Values
    - name: Update Helm Chart Values
      run: |
        # Update client values
        sed -i "s|repository:.*# DOCKER_USERNAME|repository: $DOCKER_USERNAME/devops-client # DOCKER_USERNAME|g" devops/helm/client/values.yaml
        sed -i "s|tag:.*# IMAGE_TAG|tag: \"${{ steps.version.outputs.image_tag }}\" # IMAGE_TAG|g" devops/helm/client/values.yaml
        
        # Update server values
        sed -i "s|repository:.*# DOCKER_USERNAME|repository: $DOCKER_USERNAME/devops-server # DOCKER_USERNAME|g" devops/helm/server/values.yaml
        sed -i "s|tag:.*# IMAGE_TAG|tag: \"${{ steps.version.outputs.image_tag }}\" # IMAGE_TAG|g" devops/helm/server/values.yaml
        
        echo "Updated Helm values:"
        echo "Client:"
        grep -A 2 "image:" devops/helm/client/values.yaml
        echo "Server:"
        grep -A 2 "image:" devops/helm/server/values.yaml

    # Create GitHub Release for Main Branch
    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main'
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        # Generate release notes from commits
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LATEST_TAG" ]; then
          # First release - include all commits
          RELEASE_NOTES=$(cat << EOF
        ## ðŸŽ‰ First Release
        
        This is the initial release of the DevOps System Level 4.
        
        ### âœ¨ Features
        - GitFlow workflow with semantic versioning
        - Automated CI/CD pipeline
        - Helm-based deployments
        - ArgoCD integration
        - PostgreSQL database
        - Client and Server applications
        
        ### ðŸ“¦ Docker Images
        - \`$DOCKER_USERNAME/devops-client:${{ steps.version.outputs.image_tag }}\`
        - \`$DOCKER_USERNAME/devops-server:${{ steps.version.outputs.image_tag }}\`
        EOF
        )
        else
          # Generate notes from commit messages since last tag
          echo "## ðŸ”„ Changes since $LATEST_TAG" > release_notes.md
          echo "" >> release_notes.md
          
          # Categorize commits
          git log ${LATEST_TAG}..HEAD --pretty=format:"%s" | while IFS= read -r commit; do
            if echo "$commit" | grep -qi "^feat"; then
              echo "- âœ¨ $commit" >> release_notes.md
            elif echo "$commit" | grep -qi "^fix"; then
              echo "- ðŸ› $commit" >> release_notes.md
            elif echo "$commit" | grep -qi "^BREAKING"; then
              echo "- âš ï¸ $commit" >> release_notes.md
            else
              echo "- ðŸ“ $commit" >> release_notes.md
            fi
          done
          
          echo "" >> release_notes.md
          echo "### ðŸ“¦ Docker Images" >> release_notes.md
          echo "- \`$DOCKER_USERNAME/devops-client:${{ steps.version.outputs.image_tag }}\`" >> release_notes.md
          echo "- \`$DOCKER_USERNAME/devops-server:${{ steps.version.outputs.image_tag }}\`" >> release_notes.md
          
          RELEASE_NOTES=$(cat release_notes.md)
        fi
        
        # Create GitHub Release
        gh release create "${{ steps.version.outputs.tag }}" \
          --title "Release ${{ steps.version.outputs.tag }}" \
          --notes "$RELEASE_NOTES" \
          --target main

    # Commit and Push Updated Charts (Skip CI to prevent loop)
    - name: Commit Chart Changes
      run: |
        git add devops/helm/*/values.yaml
        git diff --staged --quiet || git commit -m "Update Helm chart image tags to ${{ steps.version.outputs.image_tag }} [skip ci]" \
          && git push

    - name: Summary
      run: |
        echo "âœ… Branch: ${GITHUB_REF##*/}"
        echo "âœ… Images built and pushed to Docker Hub"
        echo "âœ… Image tag: ${{ steps.version.outputs.image_tag }}"
        if [ "${GITHUB_REF##*/}" = "main" ]; then
          echo "âœ… Release tagged: ${{ steps.version.outputs.tag }}"
        fi
        echo "âœ… Helm chart values updated"
        echo "âœ… ArgoCD will auto-sync and deploy via Helm"
