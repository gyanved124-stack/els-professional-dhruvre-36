name: Docker Build & Push

on:
  push:
    branches: ['main', master]
    paths:
      - 'development/client/**'
      - 'development/server/**'
      - 'devops/docker/**'
      - '.github/workflows/docker-build.yml'
  pull_request:
    paths:
      - 'development/client/**'
      - 'development/server/**'
      - '.github/workflows/docker-build.yml'

env:
  DOCKER_ORG: ${{ secrets.DOCKER_NAME }}

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      client: ${{ steps.filter.outputs.client }}
      server: ${{ steps.filter.outputs.server }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            client:
              - 'development/client/**'
              - '.github/workflows/docker-build.yml'
            server:
              - 'development/server/**'
              - '.github/workflows/docker-build.yml'

  build-client:
    name: Build & Push Client
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.client == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_NAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Generate tag
        id: version
        run: |
          TAG=$([ "${{ github.ref }}" == "refs/heads/main" ] && echo "latest" || echo "dev-${GITHUB_SHA:0:8}")
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Build & Push
        run: |
          docker build \
            -t $DOCKER_ORG/devops-client:${{ steps.version.outputs.tag }} \
            -f development/client/Dockerfile \
            --build-arg VITE_API_URL=${{ secrets.VITE_API_URL }} \
            development/client
          docker push $DOCKER_ORG/devops-client:${{ steps.version.outputs.tag }}

  build-server:
    name: Build & Push Server
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.server == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_NAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Generate tag
        id: version
        run: |
          TAG=$([ "${{ github.ref }}" == "refs/heads/main" ] && echo "latest" || echo "dev-${GITHUB_SHA:0:8}")
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Build & Push
        run: |
          docker build \
            -t $DOCKER_ORG/devops-server:${{ steps.version.outputs.tag }} \
            -f development/server/Dockerfile \
            development/server
          docker push $DOCKER_ORG/devops-server:${{ steps.version.outputs.tag }}
